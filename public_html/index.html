<!DOCTYPE html>
<!--
    OSWEB is distributed under the terms of the GNU General Public License 3.
    The full license should be included in the file COPYING, 
    or can be obtained from: http://www.gnu.org/licenses/gpl.txt
-->
<html>
	<head>
		<!-- Head - general definitions -->
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<!-- JavaScript -->
		<script type="text/javascript" src="js/zebra.min.js"></script>
		<script> 
			function test() { 
   				zebra.ready(function() {
					// Create the runner object within the given container.
					window['runner'] = osweb.getRunner('osweb_div');
				});
			}		
		</script> 
	<link rel="shortcut icon" href="osdoc.png"><link href="css/styles.css" rel="stylesheet"><script type="text/javascript" src="js/osweb.js"></script></head>
    <body onload="test()">				
		<!-- Body - Command bar definitions -->
		<nav class="navbar navbar-default navbar-fixed-top cogsci-navbar">
			<div class="container">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
						<span class="sr-only">Toggle navigation</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" style="padding: 7px" href="/">
						<img style="height: 100%" alt="Brand" 
						src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAABHNCSVQICAgIfAhkiAAAAAlwSFlzAAAN1wAADdcBQiibeAAAABl0RVh0U29mdHdhcmUAd3d3Lmlua3NjYXBlLm9yZ5vuPBoAAAKgSURBVEiJtZVLSJRRFMd/93uMOowmaKKjlEHkoxYWDRm2KGlpDwikENpVIPSANi567MJlq8BdFC2SogdRFBRZCwMjKCIfFaJlo4WhM77G73FbOE193/3GKayzO+fe8/+fe87/3isAqrsStcIVnUiagUJWZkkBjyWyY7i9aFBUdyVqhSN6geIVAvttCmSjJlzR+R/AAYol4oKRbktWqy/VOFBjEqvQqYgIJDA+I+mLO9wYsOifdLPmCtgt1l1KyqBFQ4NzTXm0bTIRgO3CkxEbgOa1BoYGErj+zuL88xRWFh4jKGhqcLmlgO2VOgCWC21353kZdwCIVehc21uAocHBepOqIo0j9+dJOSqWFkRwMhbKgAPcHrIy4AB9cYc77+2Mv6NK5/jWUOAJFIJoRHBss3fz01G1tJ5R2+MfbQhRVajWq0T2bTDRhTf2ekIlePPV23RDg5b1ascVgl1rdI/vSIjPqDr4nHRxfeGdvtxAgqjvmHOWJEhmroQF27tS+SctKi3w9idIGRly7xhYHRbKHoVgzldVKFBnS5bn68ispZ5VSR/z3buwqVb10/IN75o/N5DgxZi3J4YG5RGVpCwsMH3ZvWNqPxWCm4OWMtS6ElUdNSXeVJnOzUkwMOnyaNg7vaZKlWBb1Bt78NFm6Lv6IAWO8ExPionZX+dorTM8t7QsLDhUb2b88VnJ2WepICiyvqbVqzSu7MnPAH+bk1x9a2G70LbRpLJwaS6fEi6H7y0wMh38nGYlAIiEBKdiIVprDSIh76CTi5LufpuLfYuB8vydIEGOfzhPhy3lOtG0mr7MSF6NO8tewrRNG0sfNPuX25VygiWY0yQPNYnsAKb+PjunTeqOflobbi8aBNkoJLeAxD8ATiDp1m294cOJ8OcfLI/qrsFgr74AAAAASUVORK5CYII="
					>
					</a>
				</div>
				<div id="navbar" class="collapse navbar-collapse">
					<form class="navbar-form navbar-right">
						<div class="form-group">
							<button class="btn btn-success" id="run_button" type="button" status="run" onclick="runExperiment(); return false" disabled><i class="fa fa-play" aria-hidden="true"></i> Run</button>
							<button class="btn btn-default" id="fullscreen_button" type="button" onclick="toggleFullscreen(); return false" disabled><i class="fa fa-arrows-alt" aria-hidden="true"></i> Fullscreen</button>
							<button class="btn btn-default" id="console_button" type="button" onclick="toggleConsoleWindow(); return false"><i class="'fa fa-terminal" aria-hidden="true"></i> Console</button>
						</div>
					</form>
					<form class="navbar-form">
						<input type="file" id="browse" name="fileupload" style="display: none" onChange="handleChange(event);"/>
						<div class="btn-group" style="display:inline;" role="group" aria-label="Load experiment">
							<button class="btn btn-primary" type="button" id="file_button" onclick="handleBrowseClick();">Local file</button>
						</div>
						<div class="form-group" style="display:inline;">
							<div class="input-group" style="display: table;">
								<span style="width: 1%" class="input-group-addon" id="loaded-exp">Loaded:</span>
								<input type="text" class="form-control" id="filename" placeholder="No experiment loaded" readonly />
							</div>
						</div>
					</form>
				</div>
			</div>
		</nav>
		
		<!-- Body - Alert container -->
        <div class="container" style="margin-top:64px;">
			<div class="row">
				<div class="col-md-12">
					<div class="alert alert-warning">
						This is a tech preview of osweb. It is under heavy development, and not ready for general use!
					</div>
				</div>
			</div>
		</div>
		<!-- Body - Experiment canvas and form container -->
    	<div id="body_div">
	 		<!-- Body - OsWeb section -->
			<div id="osweb_div">
			</div>
			<!-- Body - Console section -->
	 		<div id="console_div">
				<div id="osweb_console" style="display: none;">
					<textarea id="osweb_console_text" rows="4" cols="80" style="width:100%;background-color:#000000;color:#00FF00;"></textarea>
				</div>
			</div>
		</div>
	</body>				
    <script>
		// Create the context container for the experiment definitions.
		var context = {};

	 	// Set position of notifications
	    alertify.set('notifier', 'position', 'bottom-right');

	    // Extend existing 'alert' dialog
	    if (!alertify.errorAlert) {
		    //define a new errorAlert base on alert
		    alertify.dialog('errorAlert', function factory() {
			    return {
				   	build:function() {
				        var errorHeader = '<span class="fa fa-times-circle fa-2x" ' +
					  	    'style="vertical-align:middle;color:#e10000;">' + 
							'</span> Application Error';
					    this.setHeader(errorHeader);
				    }
			    };
		    }, true, 'alert');
	    }

	    // Set event callback for handling error messages using alertify.
	    window.onerror = function(msg, url, line, col, error) {
		    var text = '<p><b>' + msg + '</b></p>' + '<p>See console for further details</p>';
		    alertify.errorAlert(text);
	    }

	    // Prevent the run/stop button from keeping focus after the subject nr dialog box is
	    // closed. Otherwise the stop button is activated when users press spacebar for a
	    // response to the canvas.
    	document.getElementById('run_button').onfocus = function(){
		    this.blur();
	    };

	    // Hack to set the value of the file upload button
	    document.getElementById('file_button').text = 'Select file'; 

	    // Event listener for fullscreen errors
	    // Use alert() for now, but think of something prettier (sAlert?)
		if (screenfull.enabled) {
		    document.addEventListener(screenfull.raw.fullscreenerror, function() {
			    alertify.errorAlert('Failed to activate fullscreen');
		    });
	    }

	    // Resize canvas to fit screen, when resized to fullscreen
	    if (screenfull.enabled) {
		    document.addEventListener(screenfull.raw.fullscreenchange, function() {
			    var c = runner._renderer.view;
			    if(screenfull.isFullscreen) {
				    c.old_width = c.style.width;
				    c.old_height = c.style.height;
				    var rect = c.getBoundingClientRect();
				    c.style.width = rect.width;
				    c.style.height = rect.height;
			    } else {
				    c.style.width = c.old_width;
				    c.styleheight = c.old_height;
			    }
		    });
	    }
	 
   	    /** Initialize function called whe Zebrakit is loaded.
		function create_osweb() {
   			zebra.ready(function() {
				// Create the runner object within the given container.
		        runner = osweb.getRunner('osweb_div');
			});	
    	}

   	    /**
 	     * Disable some buttons once an experiment is loaded.
 	     * @return {void}
 	     */
	    function buttonsSetToFileLoaded() {
			document.getElementById('file_button').disabled = true;
			document.getElementById('run_button').disabled = false;
			document.getElementById('fullscreen_button').disabled = false;
			document.getElementById('console_button').disabled = false;
	    }

		/** 
		 * Enable experiment loading buttons. 
 	     * @return {void}
 	     */
		function buttonsSetToFileSelection() {
			document.getElementById('file_button').disabled = false;
			document.getElementById('run_button').disabled = true;
			document.getElementById('fullscreen_button').disabled = true;
			document.getElementById('console_button').disabled = true;
		}

	    /**
 	     * Method for handling the hidden file load button.			 
 	     * @return {void}
 	     */
	    function handleBrowseClick() {
		    // Simulate a file input click.
		    var fileInput = document.getElementById('browse');
		    fileInput.click();
	    }

	    /**
 	     * Method for handling the hidden file load button.			 
	     * @param {Object} event  The change event.
 	     * @return {void}
 	     */
	    function handleChange(event) {
		    // Update the button status.
		    buttonsSetToFileLoaded();

		    // Update the interface.
		    var fileInput = document.getElementById('browse');
		    var textInput = document.getElementById('filename');
		    textInput.value = fileInput.value;

		    // Send feedback to the user.
		    alertify.message('Loaded local file: ' + textInput.value);

		    // Only select the first file.
		    var file = event.target.files[0]; 

		    // Set the experment context container.
	        context = {
				debug: true,
				introscreen: true,
				introclick: true,
				onconsole: onConsole,
				onfinished: onExperimentFinished,
				name: 'test',
				source: file, 
				target: null
			}
		}   

        /**
 	     * Show canvas in fullscreen mode (Esc minimizes it again)
 	     * @returns {void}
 	     */
	    function toggleFullscreen() {
    		if (screenfull.enabled) {
	    		screenfull.request(runner._renderer.view);
		    }
	    }	

	    /**
 	     * Show/hide console window used by the console print method.
 	     * @returns {void}
 	     */
	    function toggleConsoleWindow() {
		    var c = document.getElementById('osweb_console');
		    if (c.style.display === 'none') {
			    c.style.display = '';
		    } else {
			    c.style.display = 'none';
		    }	
	    }
	
        /**
 	     * Runs an experiment loaded from file or server.
 	     * @returns {void}
 	     */
	    function runExperiment(){
			// 'Run experiment' has been clicked
			buttonsSetToFileLoaded();

			if (document.getElementById('run_button').getAttribute('status') === 'run'){ 
				document.getElementById('run_button').setAttribute('status','stop');
				document.getElementById('run_button').innerHTML = '<i class="fa fa-stop" aria-hidden="true"></i> Stop';
				document.getElementById('run_button').classList.remove('btn-success');
				document.getElementById('run_button').classList.add('btn-danger');

	    		// Run the experiment within the Runner with the given context.
		    	runner.run(context);
			} else {
				// Stop the experiment
				alertify.confirm('Stopping experiment', 'Are you sure you want to abort the experiment?', 
					function() { 
						runner.exit(); 
					}, 
					function() { 
						/* What to do when cancelled */
					})
					.set('labels', {ok: 'Yes', cancel: 'No'}
				); 
			}
	     } 

	    /**
 	     * Callback function for optional data processing after an experiment is finished.
	     * @param {Object} data - The result data in JSON format
 	     * @param {Object} sessionData - The session data in JSON format
 	     * @returns {void}
 	     */
	    function onExperimentFinished(data, sessionData) {
			// Exit fullscreen mode, if applicable.
			if (screenfull.enabled && screenfull.isFullscreen) {
				screenfull.exit();
			}

			// Reset the input buttons
			buttonsSetToFileSelection();

			// Reset the run button.
			document.getElementById('run_button').value = 'Run experiment';
			document.getElementById('run_button').setAttribute('status','run');
			document.getElementById('run_button').innerHTML = '<i class="fa fa-play" aria-hidden="true"></i> Run';
			document.getElementById('run_button').classList.remove('btn-danger');
			document.getElementById('run_button').classList.add('btn-success');

			// Log the optional data to the console.
			if (data !== null) {
				console.log('-- experiment result data --');
				console.log(data);
			}

			// Log the o[ptional session data to the console.
			if (sessionData !== null) {
				console.log('-- experiment session data --');
				console.log(sessionData);
			}	
	    }

 		/**
     	 * Event handler to print console text to an HTML element.
     	 * @param {String} consoleText - A line of text to print to a console element.
         */
 		function onConsole(consoleText) {
			// Log the session data to the console.
			if (consoleText !== null) {
        		// Add the text to the console window.
				var a = document.getElementById('osweb_console_text').value;
            	a = a + consoleText + '\r\n';
            	document.getElementById('osweb_console_text').value = a;  
			}	
		}

    </script>
</html>