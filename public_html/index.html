<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <!-- Head - general definitions -->
        <title>osweb</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
        <!-- Head - link definitions -->
        <link rel="stylesheet" href="css/osweb.css"/>
		<script type="text/javascript" src="js/osweb.js"></script>
    </head>
    <body>
	<!-- Body - HTML definitions -->
 		<div id="body_div">
            <div id="command_div">
            	<div id="command_buttons">
					<input id="button1" type="file">
					<input id="button2" type="reset" onclick="loadDatabase();" value="Load from database">
					<input id="button3" type="reset" onclick="loadScript();" value="Load from script">
					<input id="button4" type="reset" onclick="runExperiment();" value="Run experiment" disabled>
					<input id="fullscreen_button" type="button" onclick="toggleFullscreen();" value="Show fullscreen" disabled>
				</div>
				<img id="os_logo" src='img/opensesame.png'>
            </div>
            <div id="osweb_div">
                <canvas id="osweb_canvas" width="800" height="600"></canvas>
                <div id="osweb_form" style=""></div>
                <div id="dialogoverlay"></div>
                <div id="dialogbox">
                    <div>
                        <div id="dialogboxhead"></div>
                        <div id="dialogboxbody"></div>
                        <div id="dialogboxfoot"></div>
                    </div>
                </div>	
            </div>
		</div>

        <!-- Body - Hidden experiment video player -->
        <video id="video" width="1024" height="768"></video>

        <!-- Body - Start up script -->
        <script>
            var Experiment;
            var Script;

            // Event listener for fullscreen errors
            // Use alert() for now, but think of something prettier (sAlert?)
            if (screenfull.enabled) {
			    document.addEventListener(screenfull.raw.fullscreenerror, function(){
			        console.error('Failed to enable fullscreen', event);
			    });
			}

			// Resize canvas to fit screen, when resized to fullscreen
			if (screenfull.enabled) {
			    document.addEventListener(screenfull.raw.fullscreenchange, function(){
			    	var c = document.getElementById('osweb_canvas');
			        if(screenfull.isFullscreen) {
			        	c.old_width = c.style.width;
			        	c.old_height = c.style.height;
						var rect = c.getBoundingClientRect();
						c.style.width = rect.width;
						c.style.height = rect.height;
					} else {
						c.style.width = c.old_width;
						c.styleheight = c.old_height;
					}
			    });
			}

            /**
             * Disable some buttons once an experiment is loaded.
             */
            function buttonsSetToFileLoaded(){
                document.getElementById('button1').disabled = true;
                document.getElementById('button2').disabled = true;
                document.getElementById('button3').disabled = true;
                document.getElementById('button4').disabled = false;
            }

            /**
             * Enable experiment loading buttons.
             */
            function buttonsSetToFileSelection(){
            	document.getElementById('button1').disabled = false;
				document.getElementById('button2').disabled = false;
				document.getElementById('button3').disabled = false;
				document.getElementById('fullscreen_button').disabled = true;
	            document.getElementById('command_div').style.display = 'inherit';
            }
	    
	    	/**
	    	 * Show canvas in fullscreen mode (Esc minimizes it again)
	    	 * @return {void}
	    	 */
            function toggleFullscreen(){
            	var c = document.getElementById('osweb_canvas');
            	
            	if (screenfull.enabled) {
			        screenfull.request(c);
			    }
            }

            function loadDatabase(){
	    		// Update interface.
	    		buttonsSetToFileLoaded();
			  	// Definition of the experiment object and its properties.
				Experiment = {'onFinished': onFinished, 'scriptID': 4, 'scriptURL': 'https://www.gmw.rug.nl/~qweb/osweb/', 'scriptUserID': 99};
				//Experiment = {'onFinished': onFinished, 'scriptID': 4, 'scriptURL': 'https://127.0.0.1/osweb/public_html', 'scriptUserID': 99};
		    };  

		    function loadScript(){
				// Update interface.
				buttonsSetToFileLoaded();

				Script = '---' + '\n' +
				 'API: 2' + '\n' +
				 'OpenSesame: 3.0.2' + '\n' +
				 'Platform: nt' + '\n' +
				 '---' + '\n' +
				 'set width 800' + '\n' +
				 'set uniform_coordinates "yes"' + '\n' +
				 'set title "New experiment"' + '\n' +
				 'set subject_parity "even"' + '\n' +
				 'set subject_nr 0' + '\n' +
				 'set start "block"' + '\n' +
				 'set height 600' + '\n' +
				 'set foreground "white"' + '\n' +
				 'set description "Default description"' + '\n' +
				 'set coordinates "uniform"' + '\n' +
				 'set compensation 0' + '\n' +
				 'set canvas_backend "xpyriment"' + '\n' +
				 'set background "black"' + '\n' +
				 '' + '\n' +
				 'define sequence block' + '\n' +
				 '	set flush_keyboard "yes"' + '\n' +
				 '	set description "Runs a number of items in sequence"' + '\n' +
				 '	run new_loop always' + '\n' +
				 '' + '\n' +
				 'define loop new_loop' + '\n' +
				 '	set skip 0' + '\n' +
				 '	set repeat 1' + '\n' +
				 '	set order "sequential"' + '\n' +
				 '	set offset "no"' + '\n' +
				 '	set item "trial"' + '\n' +
				 '	set description "Repeatedly runs another item"' + '\n' +
				 '	set cycles 2' + '\n' +
				 '	set column_order "stimulus;counter"' + '\n' +
				 '	set break_if "never"' + '\n' +
				 '	setcycle 0 stimulus "page 1<br/><br/>Next line"' + '\n' +
				 '	setcycle 0 counter "1"' + '\n' +
				 '	setcycle 1 stimulus "page 2"' + '\n' +
				 '	setcycle 1 counter "2"' + '\n' +
				 '	setcycle 2 stimulus "page 3"' + '\n' +
				 '	setcycle 2 counter "3"' + '\n' +
				 '	run trial' + '\n' +
				 '' + '\n' +
				 'define sequence trial' + '\n' +
				 '	set flush_keyboard "yes"' + '\n' +
				 '	set description "Runs a number of items in sequence"' + '\n' +
				 '	run welcome always' + '\n' +
				 '' + '\n' +
				 'define sketchpad welcome' + '\n' +
				 '	set start_response_interval "no"' + '\n' +
				 '	set reset_variables "no"' + '\n' +
				 '	set duration "keypress"' + '\n' +
				 '	set description "Displays stimuli"' + '\n' +
				 '	draw textline center=1 color=white font_bold=no font_family=serif font_italic=no font_size=32 html=yes show_if=always text="OpenSesame 3.0.0 [stimulus]" x=0 y=0 z_index=0' + '\n';
	                
	                // Definition of the experiment object and its properties.
				Experiment = {'onFinished': onFinished, 'script': Script};
		    };  
		    
		    function runExperiment(){
		    	// Update the interface.
		    	if(document.getElementById('button4').value == "Run experiment"){
			    	document.getElementById('button4').value = "Stop experiment";
			    	document.getElementById('fullscreen_button').disabled = false;
					//document.getElementById('command_div').style.display = 'none';
					
			  		// Run the experiment within the Runner with the given canvas and experiment object.
			        osweb.runner.run('osweb_canvas', Experiment); 
			    }else{
			    	osweb.runner.exit();
			    	// Stop the experiment
			    }
		    } 

			function onFinished(pData, pSession_data){
	        	// Exit fullscreen mode, if applicable
	        	if (screenfull.enabled && screenfull.isFullscreen) {
				   screenfull.exit();
				}

				document.getElementById('button4').value = "Run experiment";
				document.getElementById('button4').disabled = true;

	            // Reset the input buttons
	            buttonsSetToFileSelection();
	        
	            console.log(pData);
	            console.log(pSession_data);
	        }

		    function handleFileSelect(evt){
				// Update the interface.
				buttonsSetToFileLoaded();

				var files = evt.target.files; // FileList object

				// files is a FileList of File objects. List some properties.
				var output = [];
				for (var i = 0, f; f = files[i]; i++) 
				{
					var reader = new FileReader();
					reader.onload = (function(theFile) 
					{
						return function(e) 
						{
							// Definition of the experiment object and its properties.
							Experiment = {'onFinished': onFinished, 'file': e.target.result};
						};	
					})(f);
	     	   	
					// Read in the image file as a data URL.
					reader.readAsBinaryString(f);
	        	}
			}

			document.getElementById('button1').addEventListener('change', handleFileSelect, false);
        
        </script>
      
    </body>
</html>